#!/usr/bin/env bash

: ${XDG_CONFIG_HOME:=${HOME}/.config}
NOWM_CONFIG_HOME="${XDG_CONFIG_HOME}/nowm"
export NOWM_CONFIG_HOME
echo $$ > "${NOWM_CONFIG_HOME}/nowm.pid"

xprop -root -f _NET_SUPPORTED 32a -set _NET_SUPPORTED "_NET_SUPPORTED, _NET_ACTIVE_WINDOW, _NET_CLIENT_LIST"

[ -f "${HOME}/.profile" ]           && source "${HOME}/.profile"         2>&1 >/dev/null
[ -f "${HOME}/.Xresources" ]        && xrdb -merge "${HOME}/.Xresources" 2>&1 >/dev/null
[ -f "${NOWM_CONFIG_HOME}/nowmrc" ] && "${NOWM_CONFIG_HOME}/nowmrc"      2>&1 >/dev/null

gettime() { date "+%s%N"; }

dec2hex() { printf "0x%x" "${1:-0}"; }

refresh_rate=60
interval=$(( 1000000000 / refresh_rate ))

now="$(gettime)"
last="${now}"
clients=()
while : ; do
    delta="$((last - now))"
    now="$(gettime)"
    if [ "${delta}" -eq 0 ] || [ "${delta}" -ge "${interval}" ]; then
        last="${now}"

        focusing=$(xdotool getwindowfocus)
        # xprop -root -f _NET_ACTIVE_WINDOW 32x -set _NET_ACTIVE_WINDOW "$(dec2hex "${focusing}")"
        xdotool getwindowfocus windowactivate

        # TODO: _NET_CLIENT_LIST
        # clients+=??
    fi
done
